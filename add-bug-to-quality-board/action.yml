name: "Add Issue to Quality Board"
description: "Assigns new issues labeled as bugs to the Quality Board project and updates Component & Severity fields."
author: "Camunda QA Engineering Team"

inputs:
  github-token:
    description: "GitHub token with access to add issues to the project."
    required: true
  project-number:
    description: "The number of the Quality Board project."
    required: false
    default: "187"
  component-label:
    description: "Optional component label to add to the issue (e.g., 'component/zeebe')."
    required: false
    default: ""
  labels:
    description: "Optional list of labels to add/consider (comma or newline separated)."
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Add component label to issue
      if: ${{ inputs.component-label != '' }}
      uses: actions/github-script@v8
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: ['${{ inputs.component-label }}']
          });
          console.log('Added label: ${{ inputs.component-label }}');

    - name: Add provided labels to issue
      if: ${{ inputs.labels != '' }}
      uses: actions/github-script@v8
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const raw = `${{ inputs.labels }}`;

          // Support comma-separated and/or newline-separated lists
          const parsed = raw
            .split(/\r?\n|,/g)
            .map(s => s.trim())
            .filter(Boolean);

          if (parsed.length === 0) {
            console.log("No labels parsed from inputs.labels");
            return;
          }

          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: parsed
          });

          console.log("Added labels:", parsed);

    - name: Add issue to Quality Board project
      uses: actions/add-to-project@v1.0.2
      with:
        project-url: https://github.com/orgs/${{ github.repository_owner }}/projects/${{ inputs.project-number }}
        github-token: ${{ inputs.github-token }}

    - name: Get project ID
      id: get-project-id
      uses: actions/github-script@v8
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const query = `
            query($org: String!, $number: Int!) {
              organization(login: $org) {
                projectV2(number: $number) { id }
              }
            }
          `;
          const res = await github.graphql(query, {
            org: context.repo.owner,
            number: parseInt("${{ inputs.project-number }}")
          });
          console.log("Project ID:", res.organization.projectV2.id);
          core.setOutput("projectId", res.organization.projectV2.id);

    - name: Get project fields
      id: get-project-fields
      uses: actions/github-script@v8
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const projectId = "${{ steps.get-project-id.outputs.projectId }}";
          const query = `
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2FieldCommon { id name }
                      ... on ProjectV2SingleSelectField { id name options { id name } }
                    }
                  }
                }
              }
            }
          `;
          const res = await github.graphql(query, { projectId });
          console.log("Project fields:", res.node.fields.nodes);
          core.setOutput("fields", JSON.stringify(res.node.fields.nodes));

    - name: Get project item ID for issue
      id: get-item
      uses: actions/github-script@v8
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const org = context.repo.owner;
          const projectNumber = parseInt("${{ inputs.project-number }}");
          const issueNumber = context.issue.number;
          const maxRetries = 5;
          const waitMs = 5000; // 5 seconds
          let itemId = null;

          for (let attempt = 1; attempt <= maxRetries; attempt++) {
            let afterCursor = null;

            while (true) {
              const query = `
                query($org: String!, $projectNumber: Int!, $after: String) {
                  organization(login: $org) {
                    projectV2(number: $projectNumber) {
                      items(first: 100, after: $after) {
                        pageInfo { hasNextPage endCursor }
                        nodes { id content { ... on Issue { number title } } }
                      }
                    }
                  }
                }
              `;
              const res = await github.graphql(query, { org, projectNumber, after: afterCursor });
              const nodes = res.organization.projectV2.items.nodes;
              const match = nodes.find(n => n.content?.number === issueNumber);
              if (match) {
                itemId = match.id;
                break;
              }
              if (!res.organization.projectV2.items.pageInfo.hasNextPage) break;
              afterCursor = res.organization.projectV2.items.pageInfo.endCursor;
            }

            if (itemId) break;

            console.log(`Attempt ${attempt} failed, waiting ${waitMs/1000} seconds before retry...`);
            await new Promise(resolve => setTimeout(resolve, waitMs));
          }

          if (!itemId) console.warn("Project item ID not found after retries.");
          console.log("Project item ID:", itemId || "not found");
          core.setOutput("itemId", itemId || "");

    - name: Update Severity & Component fields
      if: steps.get-item.outputs.itemId != ''
      uses: actions/github-script@v8
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const projectId = "${{ steps.get-project-id.outputs.projectId }}";
          const itemId = "${{ steps.get-item.outputs.itemId }}";
          const fields = JSON.parse('${{ steps.get-project-fields.outputs.fields }}');

          // Labels from the GitHub event payload (objects with `.name`)
          const eventLabels = ${{ toJson(github.event.issue.labels) }};

          // Extra labels passed via action input (string list)
          const rawExtra = `${{ inputs.labels }}`;
          const extraLabels = rawExtra
            .split(/\r?\n|,/g)
            .map(s => s.trim())
            .filter(Boolean);

          // Backwards-compatible single component label input
          const componentInput = `${{ inputs.component-label }}`.trim();

          // Normalize to objects with `.name` so we can reuse existing logic.
          // This ensures the provided labels are considered immediately in this run,
          // even though `github.event.issue.labels` won't refresh after addLabels().
          const effectiveLabels = [
            ...(eventLabels || []),
            ...extraLabels.map(name => ({ name })),
            ...(componentInput ? [{ name: componentInput }] : [])
          ];

          const severityLabel = effectiveLabels.find(l => l.name?.startsWith("severity/"));
          const componentLabel = effectiveLabels.find(l => l.name?.startsWith("component/"));
          const severity = severityLabel ? severityLabel.name.split("/")[1] : "";
          const component = componentLabel ? componentLabel.name.split("/")[1] : "";

          const updates = { "Severity": severity, "Component": component };
          const mutation = `
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId,
                itemId: $itemId,
                fieldId: $fieldId,
                value: { singleSelectOptionId: $optionId }
              }) { projectV2Item { id } }
            }
          `;

          for (const [fieldName, optionValue] of Object.entries(updates)) {
            if (!optionValue) continue;
            const field = fields.find(f => f.name === fieldName);
            if (!field) continue;
            const option = field.options?.find(o => o.name.toLowerCase() === optionValue.toLowerCase());
            if (!option) continue;
            console.log(`Updating field "${fieldName}" with value "${optionValue}"`);
            await github.graphql(mutation, { projectId, itemId, fieldId: field.id, optionId: option.id });
          }